name: Update File and Extract IPs

on:
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Fetch, decode if needed, and combine file content
      run: |
        # Initialize or clear the proxies.txt file
        > proxies.txt
        
        # Function to check if a string is base64 encoded
        is_base64() {
          local string="$1"
          echo "$string" | base64 -d > /dev/null 2>&1
          return $?
        }
        
        # List of URLs to fetch from
        urls=(
          "https://raw.githubusercontent.com/Surfboardv2ray/TGParse/main/configtg.txt"
          "https://raw.githubusercontent.com/coldwater-10/V2RayAggregator/master/Eternity"
          "https://raw.githubusercontent.com/coldwater-10/V2rayCollectorLire/main/ss_iran.txt"
          "https://raw.githubusercontent.com/coldwater-10/V2rayCollectorLire/main/vless_iran.txt"
          "https://raw.githubusercontent.com/yebekhe/TVC/main/subscriptions/xray/base64/vmess"
          "https://raw.githubusercontent.com/yebekhe/TVC/main/subscriptions/xray/base64/vless"
          "https://raw.githubusercontent.com/yebekhe/V2Hub/main/Split/Base64/vmess"
          "https://raw.githubusercontent.com/yebekhe/V2Hub/main/Split/Base64/vless"
          "https://raw.githubusercontent.com/yebekhe/TelegramV2rayCollector/main/sub/base64/vmess"
          "https://raw.githubusercontent.com/yebekhe/TelegramV2rayCollector/main/sub/base64/vless"
          "https://raw.githubusercontent.com/coldwater-10/V2rayCollectorVpnclashfa/main/vless_iran.txt"
          "https://raw.githubusercontent.com/coldwater-10/V2rayCollectorVpnclashfa/main/vmess_iran.txt"
          "https://raw.githubusercontent.com/yebekhe/TVC/main/subscriptions/xray/base64/vmess"
          "https://raw.githubusercontent.com/yebekhe/TVC/main/subscriptions/xray/base64/vless"
          "https://raw.githubusercontent.com/coldwater-10/V2Hub3/main/Split/Base64/vless"
          "https://raw.githubusercontent.com/coldwater-10/V2Hub3/main/Split/Base64/vmess"
          "https://raw.githubusercontent.com/coldwater-10/V2Hub4/main/Split/Base64/vmess"
          "https://raw.githubusercontent.com/coldwater-10/V2Hub4/main/Split/Base64/vless"
          "https://raw.githubusercontent.com/coldwater-10/V2rayCollectorVpnclashfa/main/vmess_iran.txt"
          "https://raw.githubusercontent.com/coldwater-10/V2rayCollectorVpnclashfa/main/vless_iran.txt"
          "https://raw.githubusercontent.com/Surfboardv2ray/TGParse/main/splitted/vless"
          "https://raw.githubusercontent.com/Surfboardv2ray/TGParse/main/splitted/vmess"
          "https://raw.githubusercontent.com/coldwater-10/Vpnclashfa/main/raw/irc.txt"

          # Add more URLs as needed
        )
        
        # Fetch from each URL, decode if necessary, and append to proxies.txt
        for url in "${urls[@]}"; do
          content=$(curl -s "$url")
          if is_base64 "$content"; then
            echo "Content from $url is base64 encoded. Decoding..."
            echo "$content" | base64 -d >> proxies.txt
          else
            echo "Content from $url is not base64 encoded. Appending directly..."
            echo "$content" >> proxies.txt
          fi
          # Add a newline after each file to separate content
          echo "" >> proxies.txt
        done

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.x'

    - name: Run IP extraction script
      run: |
        python extract_ips.py

    - name: Run IP replacing script
      run: |
        python replace_ips.py

    - name: Combine lines and encrypt to base64
      run: |
        # Combine all lines into one
        tr -d '\n' < new_proxies.txt > new_proxies_oneline.txt
        
        # Encode the single-line file to base64
        base64 new_proxies_oneline.txt > new_proxies64.txt
        
        # Clean up the temporary file
        rm new_proxies_oneline.txt
        
        echo "All lines from proxies.txt have been combined into one line, encoded to base64, and saved as new_proxies64.txt"

    - name: Clean up temporary files
      run: |
        if [ -f new_proxies_oneline.txt ]; then
          rm new_proxies_oneline.txt
        fi

    - name: Split proxies file
      run: |
        python split_file.py

    - name: Check for changes
      id: changes
      run: |
        git diff --quiet && echo 'No changes' || echo '::set-output name=changed::true'   
      
    - name: Commit and Push
      if: steps.changes.outputs.changed == 'true'   
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add proxies.txt new_proxies64.txt
        timestamp=$(TZ='Asia/Tehran' date)
        git commit -m "âœ…Updated on ${timestamp}"
        git push
