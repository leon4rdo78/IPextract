name: Update File and Extract IPs

on:
  workflow_dispatch:

  schedule:
    - cron: '45 2 * * *'

  push:
    branches: [ main ]

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Fetch, decode if needed, and combine file content
      run: |
        {
          # Initialize or clear the proxies2.txt file
          > proxies.txt
          
          # Function to check if a string is base64 encoded
          is_base64() {
            local string="$1"
            echo "$string" | base64 -d > /dev/null 2>&1
            return $?
          }
          
          # List of URLs to fetch from
          urls=(
            "https://raw.githubusercontent.com/coldwater-10/V2rayCollectorVpnclashfa/main/ss_iran.txt"
            "https://raw.githubusercontent.com/coldwater-10/V2rayCollectorVpnclashfa/main/vmess_iran.txt"
            "https://raw.githubusercontent.com/coldwater-10/V2rayCollectorVpnclashfa/main/vless_iran.txt"
            "https://raw.githubusercontent.com/coldwater-10/V2rayCollectorVpnclashfa/main/trojan_iran.txt"
            "https://raw.githubusercontent.com/coldwater-10/V2rayCollector_mahsaserver/main/ss_iran.txt"
            "https://raw.githubusercontent.com/coldwater-10/V2rayCollector_mahsaserver/main/vmess_iran.txt"
            "https://raw.githubusercontent.com/coldwater-10/V2rayCollector_mahsaserver/main/vless_iran.txt"
            "https://raw.githubusercontent.com/coldwater-10/V2rayCollector_mahsaserver/main/trojan_iran.txt"
            "https://raw.githubusercontent.com/coldwater-10/V2RayAggregator/master/sub/sub_merge.txt"
            "https://raw.githubusercontent.com/coldwater-10/V2ray-Config-Lite/main/All_Configs_Sub.txt"
            "https://raw.githubusercontent.com/coldwater-10/V2ray-Config/main/All_Configs_Sub.txt"
            "https://raw.githubusercontent.com/coldwater-10/V2ray-Configs/main/All_Configs_Sub.txt"
            "https://raw.githubusercontent.com/coldwater-10/V2rayCollector/main/ss_iran.txt"
            "https://raw.githubusercontent.com/coldwater-10/V2rayCollector/main/vmess_iran.txt"
            "https://raw.githubusercontent.com/coldwater-10/V2rayCollector/main/vless_iran.txt"
            "https://raw.githubusercontent.com/coldwater-10/V2rayCollector/main/trojan_iran.txt"
            "https://raw.githubusercontent.com/coldwater-10/V2Hub2/main/Split/Normal/vmess"
            "https://raw.githubusercontent.com/coldwater-10/V2Hub/main/Split/Normal/vless"
            "https://raw.githubusercontent.com/coldwater-10/V2Hub/main/Split/Normal/reality"
            "https://raw.githubusercontent.com/coldwater-10/V2Hub1/main/Split/Normal/trojan"
            "https://raw.githubusercontent.com/coldwater-10/V2Hub1/main/Split/Normal/shadowsocks"
            "https://raw.githubusercontent.com/coldwater-10/HiN-VPN/main/subscription/normal/mix"
          )
          
          # Fetch from each URL, decode if necessary, and append to proxies.txt
          for url in "${urls[@]}"; do
            echo "Fetching from $url"
            content=$(curl -s "$url")
            if [ -n "$content" ]; then
              if is_base64 "$content"; then
                echo "Content is base64 encoded. Decoding..."
                echo "$content" | base64 -d >> proxies2.txt 2>/dev/null || echo "Failed to decode content from $url"
              else
                echo "Content is not base64 encoded. Appending directly..."
                echo "$content" >> proxies2.txt
              fi
              # Add a newline after each file to separate content
              echo "" >> proxies2.txt
            else
              echo "No content received from $url"
            fi
          done

          echo "Fetch and combine process completed."
        } > fetch_log.txt 2>&1

        echo "Fetch log:"
        cat fetch_log.txt

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.x'

    - name: Run IP extraction script
      run: |
        python extract_ips2.py

    - name: Run IP replacing script
      run: |
        python replace_ips2.py

    - name: Split proxies file
      run: |
        python split_file2.py

    - name: Check for changes
      id: changes
      run: |
        git add proxies2.txt new_proxies2.txt new_proxies642.txt unique_ips2.txt split2/*.txt
        git diff --cached --quiet && echo 'No changes' || echo '::set-output name=changed::true'   
      
    - name: Commit and Push
      if: steps.changes.outputs.changed == 'true'   
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git commit -m "âœ…Updated on $(TZ='Asia/Tehran' date)"
        git push
